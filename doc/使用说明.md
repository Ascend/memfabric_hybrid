# memfabric_hybrid

### 简介
MemFabric Hybrid面向昇腾NPU服务器和超节点，提供了构建基于HCCS互联的跨节点的HBM和DRAM的内存池的功能，可充分发挥A3超节点内D2D大带宽优势，无需配置额外Host网卡。它为用户提供了一个并行编程接口，并为跨多个NPU的内存的数据创建了一个全局地址空间，可以在NPU上通过使用MTE、RoCE、SDMA发起的数据操作来访问，还提供了由CPU发起的数据拷贝操作。

### 前置依赖
memfabric_hybrid需要在npu环境下运行

当前仅提供了aarch64的run包，**仅支持arm环境上安装**

当前run包中集成了python3.8-3.11的memfabric-hybrid的whl包，如果环境中默认python在该范围内，则会自动安装whl包，否则在使用python接口前需要用户手动安装(安装包路径参考下面目录结构)

请在环境上提前安装NPU固件驱动和CANN包([环境安装参考链接](https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/softwareinst/instg/instg_0000.html))

HDK固件驱动需要使用**25.0.RC1**及以上版本([昇腾社区HDK下载链接](https://www.hiascend.com/hardware/firmware-drivers/community))

安装完成后需要配置CANN环境变量([参考安装Toolkit开发套件包的第三步配置环境变量](https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/softwareinst/instg/instg_0008.html))

### 安装流程
run包格式为 mxc-memfabric-hybrid-${version}_${os}_${arch}.run

默认安装根路径为 /usr/local/

安装完成后需要source安装路径下的mxc/memfabric_hybrid/set_env.sh

参考安装命令如下
```bash
bash mxc-memfabric_hybrid-1.0.0_linux_aarch64.run
source /usr/local/mxc/memfabric_hybrid/set_env.sh
```

如果想要自定义安装路径，可以添加--install-path参数
```bash
bash mxc-memfabric_hybrid-1.0.0_linux_aarch64.run --install-path=${your path}
```

安装完成后目录结构如下
```
${INSTALL_PATH}/
    |--mxc
          |--memfabric_hybrid
              |-- latest
              |-- set_env.sh
              |-- ${version}
                   |-- ${arch}-${os}
                        |-- include    (头文件)
                        |-- lib64      (so库)
                        |-- whl        (python的whl包)
                   |-- uninstall.sh
                   |-- version.info

default ${INSTALL_PATH} is /usr/local/
```

### 特性简介
#### Big Memory(BM)
    * 支持创建统一内存空间存储数据
    * 支持同步数据拷贝，包含L2G, G2L, G2H, H2G
    * 自动分配rank (初始化时用户可以不指定rank,由BM内部自动生成,具体参见smem_bm_init接口)
    * 动态join和leave (参见smem_bm_join和smem_bm_leave接口)
    * 接口支持的语言: c, python

Note:
```angular2html
L2G: copy data from local HBM space to global HBM space
G2L: copy data from global HBM space to local HBM space
H2G: copy data from host DRAM memory to global HBM space
G2H: copy data from global HBM space to host DRAM memory
```

安装memfabri hybrid后，BM接口详情参见
```${INSTALL_PATH}/mxc/memfabric_hybrid/latest/${arch}-${os}/include/smem/host/smem_bm.h```

#### Share Memory(SHM)
    * 支持创建统一内存空间
    * 支持用户传入自定义数据在卡侧访问(参见smem_shm_set_extra_context和smem_shm_get_extra_context_addr接口)
    * 支持host侧全局barrier和allgather(参见smem_shm_control_barrier和smem_shm_control_allgather接口)
    * 支持超节点内，卡侧通过MTE直接访问统一内存
    * 卡侧提供基础copy接口
    * 接口支持的语言: c, python

安装memfabri hybrid后，SHM接口详情参见
```
${INSTALL_PATH}/mxc/memfabric_hybrid/latest/${arch}-${os}/include/smem/host/smem_shm.h
和
${INSTALL_PATH}/mxc/memfabric_hybrid/latest/${arch}-${os}/include/smem/device/lowlevel/smem_shm_aicore_base_api.h
```

### 使用方法
#### C接口
安装完成run包并source安装路径下的set_env.sh后，会添加memfabric_hybrid安装路径的环境变量MEMFABRIC_HYBRID_HOME_PATH

使用memfabric_hybrid相关接口时，需要include相关头文件(在${MEMFABRIC_HYBRID_HOME_PATH}/aarch64-linux/include/smem/host路径下)，并且在**链接时需要添加libmf_smem.so**(在${MEMFABRIC_HYBRID_HOME_PATH}/aarch64-linux/lib64路径下)依赖

可以通过MEMFABRIC_HYBRID_HOME_PATH环境变量指定头文件和lib库依赖路径，从而完成代码构建

具体可以参考example/bm/BmCpp中CMakeLists.txt

[C接口API列表](./API.md)

#### Python接口
安装完成run包并source安装路径下的set_env.sh后，即可在python中通过**import mf_smem**导入memfabric_hybrid的python包，然后调用python接口

python接口为c接口的封装，功能一致，具体介绍可以在python中使用help函数获取，参考如下
```python
import mf_smem  #导入memfabric_hybrid
help(mf_smem)   #查看memfabric_hybrid基础函数介绍
help(mf_smem.bm)    #查看big memory接口介绍
help(mf_smem.shm)   #查看share memory接口介绍
```

#### 安全声明

[安全声明](./SECURITYNOTE.md)